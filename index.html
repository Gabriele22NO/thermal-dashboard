
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Thermal Logger - Analisi su Minimi Locali</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
  <style>
    body { background: #111; color: white; font-family: sans-serif; text-align: center; padding-bottom: 60px; }
    canvas { background: #222; margin-top: 20px; border-radius: 8px; }
    h1 { margin-top: 20px; }
    .stats, .controls { margin-top: 20px; font-size: 18px; }
    .stats div, .controls div { margin: 5px 0; }
    button {
      margin: 5px;
      padding: 8px 16px;
      font-size: 14px;
      background: #444;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #666;
    }
    select {
      margin: 10px;
      padding: 6px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h1>Thermal Logger - Analisi Cicli (Minimi Locali)</h1>
  <div class="controls">
    <button onclick="resetZoom()">🔄 Reset Zoom</button>
    <button onclick="zoomIn()">➕ Zoom In</button>
    <button onclick="zoomOut()">➖ Zoom Out</button>
  </div>
  <div class="stats" id="stats"></div>
  <canvas id="tempChart" width="960" height="480"></canvas>

  <script>
    const csvUrl = 'https://docs.google.com/spreadsheets/d/1gNUrOS9Ibat2DtpINCAd_7ptcFk8-blRctzeK1Eyej0/gviz/tq?tqx=out:csv&sheet=Foglio1';
    let globalData = [];

    function parseTime(str) {
      const d = new Date(str);
      return isNaN(d.getTime()) ? null : d;
    }

    function getTurn(date) {
      const hour = date.getHours();
      if (hour >= 6 && hour < 14) return '06:00-14:00';
      if (hour >= 14 && hour < 22) return '14:00-22:00';
      return '22:00-06:00';
    }

    function resetZoom() {
      if (window.chart) window.chart.resetZoom();
    }

    function zoomIn() {
      if (window.chart) window.chart.zoom(1.2);
    }

    function zoomOut() {
      if (window.chart) window.chart.zoom(0.8);
    }

    function renderChart(dataSet) {
      const labels = dataSet.map(d => d.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
      const temps = dataSet.map(d => d.temp);

      // Detect valleys (minimi locali)
      const valleys = [];
      const minInterval = 180000; // 3 min
      const threshold = 390;

      for (let i = 1; i < dataSet.length - 1; i++) {
        if (temps[i] < threshold && temps[i] < temps[i - 1] && temps[i] < temps[i + 1]) {
          if (valleys.length === 0 || (dataSet[i].timestamp - dataSet[valleys[valleys.length - 1]].timestamp) > minInterval) {
            valleys.push(i);
          }
        }
      }

      const totalCycles = valleys.length;
      const timeDiffs = valleys.slice(1).map((p, i) => (dataSet[p].timestamp - dataSet[valleys[i]].timestamp) / 60000);
      const avgCycleTime = timeDiffs.reduce((a, b) => a + b, 0) / timeDiffs.length || 0;

      const turnCounts = { '06:00-14:00': 0, '14:00-22:00': 0, '22:00-06:00': 0 };
      valleys.forEach(p => {
        const turno = getTurn(dataSet[p].timestamp);
        turnCounts[turno]++;
      });

      document.getElementById("stats").innerHTML = `
        <div>🧮 Cicli completi rilevati: <b>${totalCycles}</b></div>
        <div>⏱️ Tempo medio ciclo: <b>${avgCycleTime.toFixed(1)} min</b></div>
        <div>👷‍♂️ Turno 06-14: <b>${turnCounts['06:00-14:00']}</b> cicli</div>
        <div>👷‍♂️ Turno 14-22: <b>${turnCounts['14:00-22:00']}</b> cicli</div>
        <div>🌙 Turno 22-06: <b>${turnCounts['22:00-06:00']}</b> cicli</div>
      `;

      const ctx = document.getElementById('tempChart').getContext('2d');
      if (window.chart) window.chart.destroy();
      window.chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Temperatura (°C)',
              data: temps,
              borderColor: 'lime',
              backgroundColor: 'rgba(0,255,0,0.05)',
              borderWidth: 2,
              tension: 0.3,
              pointRadius: 0
            },
            {
              type: 'scatter',
              label: 'Minimi locali (fine ciclo)',
              data: valleys.map(p => ({ x: labels[p], y: temps[p] })),
              backgroundColor: 'red',
              pointRadius: 6
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            zoom: {
              pan: { enabled: true, mode: 'x' },
              zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' }
            },
            legend: { labels: { color: 'white' } }
          },
          scales: {
            x: { ticks: { color: 'white' } },
            y: {
              title: { display: true, text: '°C', color: 'white' },
              ticks: { color: 'white' },
              grid: { color: '#444' }
            }
          }
        }
      });
    }

    Papa.parse(csvUrl, {
      download: true,
      header: true,
      complete: function(results) {
        globalData = results.data.map(row => {
          const timestamp = parseTime(row['Timestamp']);
          const temp = parseFloat(row['Temp1 (°C)']);
          return (timestamp && !isNaN(temp)) ? { timestamp, temp } : null;
        }).filter(Boolean);

        renderChart(globalData);
      }
    });
  </script>
</body>
</html>
