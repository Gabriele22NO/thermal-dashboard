<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Analisi Termica Produzione</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { background: #0e0e0e; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; }
    header { background: #1a1a1a; padding: 1em; text-align: center; border-bottom: 2px solid #333; }
    h1 { margin: 0; color: #00d8ff; font-size: 1.8em; }
    main { display: flex; flex-wrap: wrap; padding: 1em; gap: 1em; }
    canvas { background: #222; border-radius: 10px; box-shadow: 0 0 10px #000; }
    section.stats, section.controls { flex: 1; min-width: 300px; padding: 1em; }
    section.controls { max-width: 450px; background: #1c1c1c; border-left: 2px solid #333; border-radius: 10px; }
    .btn { background: #005577; color: #fff; border: none; padding: 10px; margin: 5px 0; border-radius: 5px; cursor: pointer; width: 100%; font-weight: bold; }
    .btn:hover { background: #0077aa; }
    .highlight { color: #00ff99; font-weight: bold; }
    .alert { color: #ff4444; font-weight: bold; }
    label { display: block; margin-top: 1em; font-weight: bold; }
    input[type=number] { width: 100%; padding: 6px; margin-top: 5px; background: #222; border: 1px solid #555; color: #fff; border-radius: 5px; }
    ul { padding-left: 20px; }
  </style>
</head>
<body>
  <header><h1>📈 Analisi Termica Produzione - NEW OLEF</h1></header>
  <main>
    <section class="stats">
      <canvas id="chart" width="900" height="400"></canvas>
      <div id="plotlyChart" style="display:none; width: 100%; height: 400px;"></div>
      <select id="chartLibrary" onchange="toggleChartLibrary()" class="btn">
        <option value="chartjs" selected>📈 Chart.js</option>
        <option value="plotly">📊 Plotly</option>
      </select>
    </section>
    <section class="controls">
      <label for="minTemp">Temperatura minima (°C)</label>
      <input type="number" id="minTemp" value="660">
      <label for="maxTemp">Temperatura massima (°C)</label>
      <input type="number" id="maxTemp" value="750">
      <label for="targetProd">Obiettivo produzione (pezzi / 24h)</label>
      <input type="number" id="targetProd" value="180">
      <button class="btn" onclick="applyThresholds()">📏 Applica Soglie</button>
      <button class="btn" onclick="resetZoom()">🔄 Reset Zoom</button>
      <button class="btn" onclick="exportCSV()">📤 Esporta CSV</button>
      <button class="btn" onclick="exportPDF()">🧾 Esporta Report PDF</button>
      <label for="dateStart">Data inizio:</label>
<input type="date" id="dateStart">
<label for="dateEnd">Data fine:</label>
<input type="date" id="dateEnd">
<label for="shift">Turno:</label>
<select id="shift">
  <option value="">Tutti i turni</option>
  <option value="Turno 1">Turno 1 (6-14)</option>
  <option value="Turno 2">Turno 2 (14-22)</option>
  <option value="Turno 3">Turno 3 (22-6)</option>
</select>
<button class="btn" onclick="loadData()">🔍 Applica Filtri</button>

$1
      <div id="summary"></div>
      <div id="turni"></div>
    </section>
    <section class="controls">
      <h2>📆 Trend Giornaliero</h2>
      <div id="dailyTrend"></div>
    </section>
  </main>
  <script>
    const url = 'https://docs.google.com/spreadsheets/d/1gNUrOS9Ibat2DtpINCAd_7ptcFk8-blRctzeK1Eyej0/gviz/tq?tqx=out:csv&sheet=Foglio1';
    const ctx = document.getElementById('chart').getContext('2d');
    let chart, csvData;

    function toggleChartLibrary() {
      updateChart();
    }

    function smoothData(data, window = 34) {
      return data.map((_, i, arr) => {
        const slice = arr.slice(Math.max(0, i - window + 1), i + 1);
        return slice.reduce((sum, val) => sum + val, 0) / slice.length;
      });
    }

    function parseTurno(date) {
      const h = date.getHours();
      if (h >= 6 && h < 14) return 'Turno 1';
      if (h >= 14 && h < 22) return 'Turno 2';
      return 'Turno 3';
    }

    let originalData = [];
    let times = [];
    let ciclo = [];

    function loadData() {
      Papa.parse(url, {
        download: true,
        header: true,
        complete: res => {
          csvData = res.data.filter(r => {
  if (!r.Timestamp || !r["Temp1 (°C)"]) return false;
  const [month, day, timePart] = r.Timestamp.split("/");
  const [year, time] = timePart.split(" ");
  const iso = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}T${time}`;
  const date = new Date(iso);
  const dateStart = document.getElementById('dateStart').value;
  const dateEnd = document.getElementById('dateEnd').value;
  const shift = document.getElementById('shift').value;
  if (dateStart && date < new Date(dateStart)) return false;
  if (dateEnd && date > new Date(dateEnd + 'T23:59:59')) return false;
  if (shift) {
    const h = date.getHours();
    if ((shift === 'Turno 1' && (h < 6 || h >= 14)) ||
        (shift === 'Turno 2' && (h < 14 || h >= 22)) ||
        (shift === 'Turno 3' && (h >= 6 && h < 22))) {
      return false;
    }
  }
  r._parsedDate = date;
  return true;
});
          times = csvData.map(r => r._parsedDate);
          originalData = csvData.map(r => parseFloat(r["Temp1 (°C)"]));
          ciclo = csvData.map(r => r.Ciclo || "");
          updateChart();
        }
      });
    }

    function applyThresholds() {
      const min = parseFloat(document.getElementById('minTemp').value);
      const max = parseFloat(document.getElementById('maxTemp').value);
      updateChart(min, max);
    }

    function exportCSV() {
      const csv = Papa.unparse(csvData);
      const blob = new Blob([csv], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'dati_produzione.csv';
      a.click();
    }

    function exportPDF() {
      import('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js').then(jsPDF => {
        const { jsPDF: PDF } = jsPDF;
        const pdf = new PDF();
        pdf.text("Report Produzione - NEW OLEF", 10, 10);
        pdf.html(document.body, {
          x: 10,
          y: 20,
          callback: () => pdf.save('report_produzione.pdf')
        });
      });
    }

    loadData();
    setInterval(loadData, 10000);
  </script>
</body>
</html>
