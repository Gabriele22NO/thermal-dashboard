<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Analisi Termica Produzione</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { background: #111; color: #eee; font-family: sans-serif; padding: 1rem; }
    #summary ul { list-style: none; padding: 0; }
    #summary li { margin: 0.3rem 0; }
    canvas, #plotlyChart { margin-top: 1rem; }
    #controls { margin: 1rem 0; }
    #tableTurni { width: 100%; margin-top: 1rem; border-collapse: collapse; }
    #tableTurni th, #tableTurni td { border: 1px solid #666; padding: 0.5rem; text-align: center; }
  </style>
</head>
<body>
  <h1>Dashboard Analisi Termica</h1>
  <div id="controls">
    <label for="chartLibrary">Libreria grafico:</label>
    <select id="chartLibrary" onchange="toggleChartLibrary()">
      <option value="chartjs">Chart.js</option>
      <option value="plotly" selected>Plotly</option>
    </select>
    <label for="filterTurno">Filtro turno:</label>
    <select id="filterTurno" onchange="updateChart()">
      <option value="all">Tutti</option>
      <option value="A">Turno A</option>
      <option value="B">Turno B</option>
      <option value="C">Turno C</option>
    </select>
  </div>

  <div id="summary"></div>
  <table id="tableTurni"></table>
  <canvas id="chart" style="display:none;"></canvas>
  <div id="plotlyChart" style="width: 100%; height: 400px;"></div>
  <div id="istogrammaTurni" style="width: 100%; height: 300px;"></div>

  <script>
    const ctx = document.getElementById('chart').getContext('2d');
    let chart, csvData, originalData = [], times = [], ciclo = [], lastCSV = '', currentChartLibrary = 'plotly';

    function smoothData(data, window = 34) {
      return data.map((_, i, arr) => {
        const slice = arr.slice(Math.max(0, i - window + 1), i + 1);
        return slice.reduce((sum, val) => sum + val, 0) / slice.length;
      });
    }

    function toggleChartLibrary() {
      currentChartLibrary = document.getElementById('chartLibrary').value;
      updateChart();
    }

    function getTurno(date) {
      const hour = date.getHours();
      if (hour >= 6 && hour < 14) return 'A';
      if (hour >= 14 && hour < 22) return 'B';
      return 'C';
    }

    function updateChart() {
      if (!times.length || !originalData.length) return;
      const filtroTurno = document.getElementById('filterTurno').value;
      const smoothed = smoothData(originalData);
      const anomalie = [], tempi = [], turniData = { A: [], B: [], C: [] }, scartiTurno = { A: 0, B: 0, C: 0 };

      for (let i = 1; i < times.length; i++) {
        if (ciclo[i] === 'ok') {
          const delta = (times[i] - times[i - 1]) / 1000; // secondi
          tempi.push(delta);
          const turno = getTurno(times[i]);
          turniData[turno].push({ tempo: delta, index: i });
        } else if (ciclo[i] === 'scarto') {
          const turno = getTurno(times[i - 1]);
          scartiTurno[turno]++;
        }
      }

      const medioVal = tempi.length ? tempi.reduce((a, b) => a + b) / tempi.length : 0;
      const medio = medioVal.toFixed(1);

      for (let i = 1; i < times.length; i++) {
        if (ciclo[i] === 'ok') {
          const delta = (times[i] - times[i - 1]) / 1000;
          if (delta > medioVal * 1.5) anomalie.push(i);
        }
      }

      const riassuntoTurni = Object.entries(turniData).map(([turno, entries]) => {
        const buoni = entries.length - scartiTurno[turno];
        const scarti = scartiTurno[turno];
        const eff = entries.length ? (buoni / entries.length) * 100 : 0;

        const primo = entries.length ? times[entries[0].index] : null;
        const ultimo = entries.length ? times[entries[entries.length - 1].index] : null;
        const durata = primo && ultimo ? (ultimo - primo) / 1000 : 0; // in secondi
        const mediaTempo = buoni > 0 ? (durata / buoni).toFixed(1) : '-';

        return { turno, buoni, scarti, eff, mediaTempo };
      });

      const best = riassuntoTurni.reduce((a, b) => (b.eff > a.eff ? b : a), { eff: -1 });

      document.getElementById('summary').innerHTML = `
        <ul>
          <li><b>Media tempo ciclo:</b> ${medio} sec</li>
          <li><b>Cicli anomali:</b> ${anomalie.length}</li>
          <li><b>Turno migliore:</b> Turno ${best.turno} (${best.eff.toFixed(1)}% efficienza)</li>
        </ul>`;

      document.getElementById('tableTurni').innerHTML = `
        <thead><tr><th>Turno</th><th>Buoni</th><th>Scarti</th><th>Efficienza %</th><th>Media ciclo (sec)</th></tr></thead>
        <tbody>
          ${riassuntoTurni.map(r => `<tr><td>${r.turno}</td><td>${r.buoni}</td><td>${r.scarti}</td><td>${r.eff.toFixed(1)}</td><td>${r.mediaTempo}</td></tr>`).join('')}
        </tbody>`;

      if (currentChartLibrary === 'chartjs') {
        document.getElementById('plotlyChart').style.display = 'none';
        document.getElementById('chart').style.display = 'block';
      } else {
        document.getElementById('chart').style.display = 'none';
        document.getElementById('plotlyChart').style.display = 'block';

        const okMarkers = times.map((t, i) => (ciclo[i] === 'ok' && (filtroTurno === 'all' || getTurno(t) === filtroTurno)) ? smoothed[i] : null);
        const scartoMarkers = times.map((t, i) => (ciclo[i] === 'scarto' && (filtroTurno === 'all' || getTurno(t) === filtroTurno)) ? smoothed[i] : null);
        const anomaliaMarkers = times.map((t, i) => (anomalie.includes(i) && (filtroTurno === 'all' || getTurno(times[i]) === filtroTurno)) ? smoothed[i] : null);

        Plotly.react('plotlyChart', [
          {
            x: times,
            y: smoothed,
            type: 'scatter',
            mode: 'lines',
            line: { color: '#00ffcc' },
            fill: 'tozeroy',
            fillcolor: 'rgba(0,255,200,0.1)',
            name: 'Temperatura'
          },
          {
            x: times,
            y: okMarkers,
            mode: 'markers',
            type: 'scatter',
            marker: { color: 'lime', size: 8 },
            name: 'Ciclo OK'
          },
          {
            x: times,
            y: scartoMarkers,
            mode: 'markers',
            type: 'scatter',
            marker: { color: 'red', size: 8 },
            name: 'Scarto'
          },
          {
            x: times,
            y: anomaliaMarkers,
            mode: 'markers',
            type: 'scatter',
            marker: { color: 'yellow', size: 8 },
            name: 'Anomalia'
          }
        ], {
          plot_bgcolor: '#222',
          paper_bgcolor: '#222',
          font: { color: '#eee' },
          margin: { t: 30, b: 40 },
          xaxis: { title: 'Orario' },
          yaxis: { title: 'Temp (°C)', range: [350, 400] }
        });

        Plotly.newPlot('istogrammaTurni', [{
          x: riassuntoTurni.map(r => r.turno),
          y: riassuntoTurni.map(r => r.eff),
          type: 'bar',
          marker: { color: ['#0f0', '#ff0', '#f00'] },
          name: 'Efficienza %'
        }], {
          title: 'Efficienza per Turno',
          plot_bgcolor: '#222',
          paper_bgcolor: '#222',
          font: { color: '#eee' },
          xaxis: { title: 'Turno' },
          yaxis: { title: 'Efficienza (%)' }
        });
      }
    }

    function loadData() {
      Papa.parse('https://docs.google.com/spreadsheets/d/1gNUrOS9Ibat2DtpINCAd_7ptcFk8-blRctzeK1Eyej0/gviz/tq?tqx=out:csv&sheet=Foglio1', {
        download: true,
        header: true,
        complete: res => {
          const newCSV = JSON.stringify(res.data);
          if (newCSV === lastCSV) return;
          lastCSV = newCSV;

          csvData = res.data.filter(r => r.Timestamp && r["Temp1 (°C)"]);
          times = csvData.map(r => {
            const [mdy, time] = r.Timestamp.split(" ");
            const [month, day, year] = mdy.split("/");
            return new Date(`${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}T${time}`);
          });
          originalData = csvData.map(r => parseFloat(r["Temp1 (°C)"])).filter(val => !isNaN(val));
          ciclo = csvData.map(r => r.Ciclo || "");
          updateChart();
        }
      });
    }

    loadData();
  </script>
</body>
</html>
