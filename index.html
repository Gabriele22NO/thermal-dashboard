
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Thermal Logger - Analisi Produzione</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { background: #111; color: white; font-family: sans-serif; text-align: center; padding-bottom: 50px; }
    canvas { background: #222; margin-top: 20px; border-radius: 8px; }
    h1 { margin-top: 20px; }
    .stats { margin-top: 20px; font-size: 18px; }
    .stats div { margin: 5px 0; }
  </style>
</head>
<body>
  <h1>Thermal Logger - Produzione Analizzata</h1>
  <div class="stats" id="stats"></div>
  <canvas id="tempChart" width="900" height="450"></canvas>

  <script>
    const csvUrl = 'https://docs.google.com/spreadsheets/d/1gNUrOS9Ibat2DtpINCAd_7ptcFk8-blRctzeK1Eyej0/gviz/tq?tqx=out:csv&sheet=Foglio1';

    function parseTime(str) {
      const d = new Date(str);
      return isNaN(d.getTime()) ? null : d;
    }

    function getTurn(date) {
      const hour = date.getHours();
      if (hour >= 6 && hour < 14) return '06:00-14:00';
      if (hour >= 14 && hour < 22) return '14:00-22:00';
      return '22:00-06:00';
    }

    Papa.parse(csvUrl, {
      download: true,
      header: true,
      complete: function(results) {
        const data = results.data;
        const labels = [];
        const temps = [];
        const times = [];

        data.forEach(row => {
          const t = parseTime(row['Timestamp']);
          const temp = parseFloat(row['Temp1 (¬∞C)']);
          if (t && !isNaN(temp)) {
            times.push(t);
            labels.push(t.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
            temps.push(temp);
          }
        });

        // Rileva picchi (potenziali cicli di colata)
        const peaks = [];
        const minInterval = 180000; // 3 minuti in ms
        const threshold = 100;

        for (let i = 1; i < temps.length - 1; i++) {
          if (temps[i] > threshold && temps[i] > temps[i - 1] && temps[i] > temps[i + 1]) {
            if (peaks.length === 0 || (times[i] - times[peaks[peaks.length - 1]]) > minInterval) {
              peaks.push(i);
            }
          }
        }

        // Statistiche
        const totalPieces = peaks.length;
        const timeDiffs = peaks.slice(1).map((p, i) => (times[p] - times[peaks[i]]) / 60000);
        const avgCycleTime = timeDiffs.reduce((a, b) => a + b, 0) / timeDiffs.length || 0;

        const turnCounts = { '06:00-14:00': 0, '14:00-22:00': 0, '22:00-06:00': 0 };
        peaks.forEach(p => {
          const turno = getTurn(times[p]);
          turnCounts[turno]++;
        });

        // Mostra statistiche
        document.getElementById("stats").innerHTML = `
          <div>üßÆ Pezzi totali rilevati: <b>${totalPieces}</b></div>
          <div>‚è±Ô∏è Tempo medio ciclo: <b>${avgCycleTime.toFixed(1)} min</b></div>
          <div>üë∑‚Äç‚ôÇÔ∏è Turno 06-14: <b>${turnCounts['06:00-14:00']}</b> pezzi</div>
          <div>üë∑‚Äç‚ôÇÔ∏è Turno 14-22: <b>${turnCounts['14:00-22:00']}</b> pezzi</div>
          <div>üåô Turno 22-06: <b>${turnCounts['22:00-06:00']}</b> pezzi</div>
        `;

        // Chart.js
        const ctx = document.getElementById('tempChart').getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'Temperatura (¬∞C)',
                data: temps,
                borderColor: 'lime',
                backgroundColor: 'rgba(0,255,0,0.05)',
                borderWidth: 2,
                tension: 0.3,
                pointRadius: 0
              },
              {
                type: 'scatter',
                label: 'Picchi (pezzi)',
                data: peaks.map(p => ({ x: labels[p], y: temps[p] })),
                backgroundColor: 'red',
                pointRadius: 5
              }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { labels: { color: 'white' } }
            },
            scales: {
              x: { ticks: { color: 'white' } },
              y: {
                title: { display: true, text: '¬∞C', color: 'white' },
                ticks: { color: 'white' },
                grid: { color: '#444' }
              }
            }
          }
        });
      }
    });
  </script>
</body>
</html>
